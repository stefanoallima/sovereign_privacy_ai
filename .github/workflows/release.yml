name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
          - platform: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Windows: initialise MSVC environment so cmake can detect cl.exe
      - name: Setup MSVC (Windows)
        if: matrix.platform == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake llvm
          LLVM_PATH=$(brew --prefix llvm)
          echo "$LLVM_PATH/bin" >> $GITHUB_PATH
          echo "LIBCLANG_PATH=$LLVM_PATH/lib" >> $GITHUB_ENV
          # aarch64-apple-darwin minimum is macOS 11.0 (Apple Silicon launched with 11.0).
          # cmake crate 0.1.57 adds --target=arm64-apple-macosx (unversioned) to cmake flags.
          # With Apple clang 16, an unversioned --target overrides any -mmacosx-version-min
          # and leaves the OS as "unknown", making std::filesystem appear unavailable.
          # Fix: inject --target=arm64-apple-macos11.0 (versioned) into CFLAGS/CXXFLAGS so
          # it is appended LAST and overrides the unversioned triple set by the cmake crate.
          echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          echo "CFLAGS=--target=arm64-apple-macos11.0 -mmacosx-version-min=11.0" >> $GITHUB_ENV
          echo "CXXFLAGS=--target=arm64-apple-macos11.0 -mmacosx-version-min=11.0" >> $GITHUB_ENV
          # Use a short target dir to keep paths manageable
          echo "CARGO_TARGET_DIR=/tmp/ct" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          # cmake is pre-installed on the runner; only install LLVM for bindgen
          choco install llvm -y
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          # Use a short target dir to avoid Windows MAX_PATH issues with llama.cpp cmake temp files
          echo "CARGO_TARGET_DIR=D:\ct" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # Bundle ONNX Runtime 1.20.1 so GLiNER PII detection works on user machines
      - name: Bundle ONNX Runtime (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p apps/desktop/src-tauri/onnxruntime
          curl -L "https://github.com/microsoft/onnxruntime/releases/download/v1.20.1/onnxruntime-osx-arm64-1.20.1.tgz" -o /tmp/ort.tgz
          tar -xzf /tmp/ort.tgz -C /tmp/
          # Copy the versioned dylib, rename to unversioned so ORT_DYLIB_PATH is stable
          cp /tmp/onnxruntime-osx-arm64-1.20.1/lib/libonnxruntime.1.20.1.dylib \
             apps/desktop/src-tauri/onnxruntime/libonnxruntime.dylib

      - name: Bundle ONNX Runtime (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          New-Item -ItemType Directory -Force -Path "apps/desktop/src-tauri/onnxruntime"
          Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v1.20.1/onnxruntime-win-x64-1.20.1.zip" -OutFile "$env:TEMP\ort.zip"
          Expand-Archive -Path "$env:TEMP\ort.zip" -DestinationPath "$env:TEMP\ort"
          Copy-Item "$env:TEMP\ort\onnxruntime-win-x64-1.20.1\lib\onnxruntime.dll" "apps/desktop/src-tauri/onnxruntime/"
          Copy-Item "$env:TEMP\ort\onnxruntime-win-x64-1.20.1\lib\onnxruntime_providers_shared.dll" "apps/desktop/src-tauri/onnxruntime/"

      - name: Install frontend dependencies
        working-directory: apps/desktop
        run: pnpm install

      - name: Set version from tag
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # strip leading 'v'
          # Patch version into tauri.conf.json so installer filename matches the tag.
          # Use perl instead of sed -i because BSD sed (macOS) requires 'sed -i ""' while
          # GNU sed (Linux/Windows) requires 'sed -i'. perl -i works on all platforms.
          perl -i -pe "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" apps/desktop/src-tauri/tauri.conf.json
          echo "Building version $VERSION"

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # aarch64-apple-darwin minimum is 11.0 (Apple Silicon launched with macOS 11)
          MACOSX_DEPLOYMENT_TARGET: "11.0"
          # Signing key for auto-updater (set in GitHub repo secrets)
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: apps/desktop
          tagName: ${{ github.ref_name }}
          releaseName: 'Sovereign AI ${{ github.ref_name }}'
          releaseBody: |
            Download Sovereign AI for your platform:
            - **Windows**: `.exe` installer
            - **macOS (Apple Silicon)**: `.dmg` for M1/M2/M3
            - **macOS (Intel)**: `.dmg` for Intel Macs
          releaseDraft: false
          prerelease: false
          updaterJsonKeepUniversal: true
          args: --target ${{ matrix.target }}
